<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>net9.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <AssemblyName>DerpTech.TestGame</AssemblyName>
    <RootNamespace>TestGame</RootNamespace>
    <DerpDocCliProject>$(MSBuildProjectDirectory)/../../../Tools/DerpDoc.Cli/DerpDoc.Cli.csproj</DerpDocCliProject>
    <DerpDocDatabaseRoot>$(MSBuildProjectDirectory)/Database</DerpDocDatabaseRoot>
    <DerpDocGeneratedDir>$(MSBuildProjectDirectory)/obj/DerpDocGenerated</DerpDocGeneratedDir>
    <DerpDocBinaryPath>$(MSBuildProjectDirectory)/Resources/Database/TestGame.derpdoc</DerpDocBinaryPath>
  </PropertyGroup>

  <ItemGroup>
    <ProjectReference Include="..\..\..\Engine\src\Engine\Engine.csproj" />
    <ProjectReference Include="..\..\..\Shared\DerpDoc.Runtime\DerpDoc.Runtime.csproj" />
    <ProjectReference Include="..\..\..\Shared\DerpLib.DI\Annotations\Derp.DI.Annotations.csproj" />
    <ProjectReference Include="..\..\..\Shared\DerpLib.DI\Generator\Derp.DI.Generator.csproj" OutputItemType="Analyzer" ReferenceOutputAssembly="false" />
  </ItemGroup>

  <ItemGroup>
    <EngineFontSources Include="..\..\..\Engine\Content\db\fonts\*.font" />
    <EngineFontOutputs Include="@(EngineFontSources->'$(TargetDir)data/db/fonts/%(Filename)%(Extension)')" />
  </ItemGroup>

  <ItemGroup>
    <Content Include="Resources/Database/*.derpdoc" CopyToOutputDirectory="PreserveNewest" />
  </ItemGroup>

  <Target Name="ExportDerpDocDatabase"
          BeforeTargets="CoreCompile"
          Inputs="$(DerpDocDatabaseRoot)/project.json;$(DerpDocDatabaseRoot)/tables/**/*.json*"
          Outputs="$(DerpDocGeneratedDir)/GameDatabase.g.cs;$(DerpDocBinaryPath)">
    <RemoveDir Directories="$(DerpDocGeneratedDir)" />
    <MakeDir Directories="$(DerpDocGeneratedDir);$(MSBuildProjectDirectory)/Resources/Database" />
    <Exec Command="dotnet run --project &quot;$(DerpDocCliProject)&quot; -- export &quot;$(DerpDocDatabaseRoot)&quot; --generated &quot;$(DerpDocGeneratedDir)&quot; --bin &quot;$(DerpDocBinaryPath)&quot; --no-manifest" />
    <ItemGroup>
      <Compile Include="$(DerpDocGeneratedDir)/*.g.cs" />
    </ItemGroup>
  </Target>

  <Target Name="CopyEngineFontsForTestGame"
          BeforeTargets="Build"
          Inputs="@(EngineFontSources)"
          Outputs="@(EngineFontOutputs)"
          Condition="'@(EngineFontSources)' != ''">
    <PropertyGroup>
      <_TestGameFontOutputDir>$(TargetDir)data/db/fonts</_TestGameFontOutputDir>
    </PropertyGroup>

    <Message Importance="High" Text="Copying engine fonts into $(_TestGameFontOutputDir)..." />
    <MakeDir Directories="$(_TestGameFontOutputDir)" />
    <Copy SourceFiles="@(EngineFontSources)" DestinationFolder="$(_TestGameFontOutputDir)" SkipUnchangedFiles="true" />
  </Target>

</Project>
