<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>net9.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <EmitCompilerGeneratedFiles>true</EmitCompilerGeneratedFiles>
    <Configurations>Debug;Release;SteamRelease</Configurations>

    <!-- NativeAOT Configuration - only enabled when NativeAot=true is passed -->
    <!-- Development builds (run.sh) use fast JIT by default -->
    <!-- Use custom property to avoid propagating to source generator projects -->
    <PublishAot Condition="'$(NativeAot)' == 'true'">true</PublishAot>
    <SelfContained Condition="'$(NativeAot)' == 'true'">true</SelfContained>
    <EnableAotAnalyzer Condition="'$(NativeAot)' == 'true'">true</EnableAotAnalyzer>
    <TrimMode Condition="'$(NativeAot)' == 'true'">full</TrimMode>
    <InvariantGlobalization Condition="'$(NativeAot)' == 'true'">false</InvariantGlobalization>
    <DefineConstants Condition="'$(NativeAot)' == 'true'">$(DefineConstants);NATIVE_AOT</DefineConstants>
  </PropertyGroup>

  <!-- Steam Release Build - defines STEAM_BUILD constant -->
  <PropertyGroup Condition="'$(Configuration)' == 'SteamRelease'">
    <DefineConstants>$(DefineConstants);STEAM_BUILD</DefineConstants>
    <Optimize>true</Optimize>
  </PropertyGroup>

  <!-- HOT_RELOAD enabled by default in Debug and Release -->
  <!-- Disable with: dotnet build -p:FullProduction=true -->
  <PropertyGroup Condition="'$(FullProduction)' != 'true'">
    <DefineConstants>$(DefineConstants);HOT_RELOAD</DefineConstants>
  </PropertyGroup>

  <!-- Production build - disables sync checks and desync detection -->
  <!-- Enable with: dotnet build -p:ProductionBuild=true -->
  <PropertyGroup Condition="'$(ProductionBuild)' == 'true'">
    <DefineConstants>$(DefineConstants);PRODUCTION_BUILD</DefineConstants>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Friflo.Engine.ECS" Version="3.*" />
    <PackageReference Include="LiteNetLib" Version="1.*" />
    <PackageReference Include="Pure.DI" Version="2.*">
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
      <PrivateAssets>all</PrivateAssets>
    </PackageReference>
    <PackageReference Include="R3" Version="1.*" />
    <PackageReference Include="Raylib-cs" Version="7.0.0" />
    <PackageReference Include="Serilog" Version="4.*" />
    <PackageReference Include="Serilog.Sinks.Console" Version="6.*" />
    <PackageReference Include="Serilog.Sinks.File" Version="7.0.0" />
    <PackageReference Include="TracyWrapper" Version="0.20.2" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\..\..\Shared\Core\Core.csproj" />
    <ProjectReference Include="..\..\..\Shared\Core.RaylibInput\Core.RaylibInput.csproj" />
    <ProjectReference Include="..\..\..\Shared\Rollback\Rollback.csproj" />
    <ProjectReference Include="..\..\..\Shared\DesyncDetection\DesyncDetection.csproj" />
    <ProjectReference Include="..\..\..\Shared\Networking\Networking.csproj" />
    <ProjectReference Include="..\..\..\Shared\FlowField\FlowField.csproj" />
    <ProjectReference Include="..\..\..\Shared\SimTable\Annotations\SimTable.Annotations.csproj" />
    <ProjectReference Include="..\..\..\Shared\SimTable\Generator\SimTable.Generator.csproj" OutputItemType="Analyzer" ReferenceOutputAssembly="false" />
    <ProjectReference Include="..\..\..\Shared\Grid\Annotations\Grid.Annotations.csproj" />
    <ProjectReference Include="..\..\..\Shared\Grid\Generator\Grid.Generator.csproj" OutputItemType="Analyzer" ReferenceOutputAssembly="false" />
    <ProjectReference Include="..\..\..\Shared\ConfigRefresh\Annotations\ConfigRefresh.Annotations.csproj" />
    <ProjectReference Include="..\..\..\Shared\ConfigRefresh\Generator\ConfigRefresh.Generator.csproj" OutputItemType="Analyzer" ReferenceOutputAssembly="false" />
    <ProjectReference Include="..\..\..\Shared\DerpTech2D.AotGen\DerpTech2D.AotGen.csproj" OutputItemType="Analyzer" ReferenceOutputAssembly="false" />
    <ProjectReference Include="..\Catrillion.GameData\Catrillion.GameData.csproj" />
  </ItemGroup>

  <!-- GameDocDatabase binary generation for Release builds -->
  <PropertyGroup>
    <GameDataDir>$(MSBuildProjectDirectory)\..\Catrillion.GameData\Data</GameDataDir>
  </PropertyGroup>
  <Import Project="..\..\..\Shared\GameDocDatabase\Runtime\build\GameDocDatabase.Runtime.targets" />

  <ItemGroup Condition="'$(RuntimeIdentifier)' != 'browser-wasm'">
    <Content Include="..\..\..\Shared\runtimes\**\*.*">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Link>runtimes\%(RecursiveDir)%(Filename)%(Extension)</Link>
    </Content>
    <Content Include="Resources\**\*.*">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Content>
    <!-- JSON data files are NOT copied to output:
         - Debug: Reads from source directory directly (for hot-reload)
         - Release: Uses pre-compiled .bin files (TODO: implement binary serialization) -->
  </ItemGroup>

  <ItemGroup Condition="'$(RuntimeIdentifier)' == 'osx-arm64'">
    <Content Include="..\..\..\Shared\runtimes\osx-arm64\native\libraylib.dylib">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <TargetPath>libraylib_bundle.dylib</TargetPath>
    </Content>
  </ItemGroup>

  <ItemGroup Condition="'$(RuntimeIdentifier)' == 'osx-x64'">
    <Content Include="..\..\..\Shared\runtimes\osx-x64\native\libraylib.dylib">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <TargetPath>libraylib_bundle.dylib</TargetPath>
    </Content>
  </ItemGroup>

  <ItemGroup Condition="'$(RuntimeIdentifier)' == 'win-x64'">
    <Content Include="..\..\..\Shared\runtimes\win-x64\native\raylib.dll">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <TargetPath>raylib_bundle.dll</TargetPath>
    </Content>
  </ItemGroup>

  <ItemGroup Condition="'$(RuntimeIdentifier)' == 'linux-x64'">
    <Content Include="..\..\..\Shared\runtimes\linux-x64\native\libraylib.so">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <TargetPath>libraylib_bundle.so</TargetPath>
    </Content>
  </ItemGroup>

  <!-- Steam SDK native libraries (download from https://partner.steamgames.com/) -->
  <ItemGroup Condition="'$(RuntimeIdentifier)' == 'osx-arm64' And Exists('..\..\..\Shared\SteamSDK\redistributable_bin\osx\libsteam_api.dylib')">
    <Content Include="..\..\..\Shared\SteamSDK\redistributable_bin\osx\libsteam_api.dylib">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Content>
  </ItemGroup>

  <ItemGroup Condition="'$(RuntimeIdentifier)' == 'osx-x64' And Exists('..\..\..\Shared\SteamSDK\redistributable_bin\osx\libsteam_api.dylib')">
    <Content Include="..\..\..\Shared\SteamSDK\redistributable_bin\osx\libsteam_api.dylib">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Content>
  </ItemGroup>

  <ItemGroup Condition="'$(RuntimeIdentifier)' == 'win-x64' And Exists('..\..\..\Shared\SteamSDK\redistributable_bin\win64\steam_api64.dll')">
    <Content Include="..\..\..\Shared\SteamSDK\redistributable_bin\win64\steam_api64.dll">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Content>
  </ItemGroup>

  <ItemGroup Condition="'$(RuntimeIdentifier)' == 'linux-x64' And Exists('..\..\..\Shared\SteamSDK\redistributable_bin\linux64\libsteam_api.so')">
    <Content Include="..\..\..\Shared\SteamSDK\redistributable_bin\linux64\libsteam_api.so">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Content>
  </ItemGroup>

  <ItemGroup>
    <Using Include="FixedMath" />
  </ItemGroup>
</Project>
